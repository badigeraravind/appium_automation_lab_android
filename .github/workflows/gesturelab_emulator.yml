name: gesturelab-emulator-ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  run-emulator-and-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      # Optional secret; conftest.py falls back to http://127.0.0.1:4723/wd/hub when empty/missing.
      APPIUM_SERVER_URL: ${{ secrets.APPIUM_SERVER_URL }}
      DEVICE_NAME: emulator-5554

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (required for Android SDK/tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install prerequisites (curl, unzip, etc.)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip libgl1-mesa-dev qemu-kvm curl gnupg apt-transport-https ca-certificates

      - name: Download Android commandline-tools
        run: |
          set -eux
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          sudo mkdir -p $ANDROID_SDK_ROOT
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          sudo unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT
          sudo mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
          # move into expected layout (ignore errors)
          sudo mv $ANDROID_SDK_ROOT/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/ || true
          # export path for subsequent sdkmanager usage
          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
          # ensure ownership so sdkmanager can write licenses
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT

      - name: Install Android SDK & accept licenses
        run: |
          set -eux
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown -R $USER:$USER $ANDROID_SDK_ROOT

          # Download command-line tools
          cd /tmp
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          unzip -q cmdline-tools.zip -d $ANDROID_SDK_ROOT
          mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
          mv $ANDROID_SDK_ROOT/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/ || true
          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin

          # Accept all SDK licenses
          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT --licenses || true

          # Install required packages non-interactively
          yes | sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" \
          "platforms;android-33" \
          "system-images;android-33;google_apis;x86_64" \
          "emulator"

      - name: Launch emulator, wait for ready and install APK (atomic)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_3a
          emulator-options: > 
            -no-window -no-audio -no-boot-anim -gpu swiftshader_indirect -wipe-data -no-snapshot
          script: |
            set -eux

            echo "=== emulator: initial adb devices ==="
            adb devices -l || true

            # Wait for some adb entry (may be offline initially)
            echo "Waiting for adb to show a device entry..."
            for i in $(seq 1 40); do
              adb devices -l
              if adb devices | awk 'NR>1{print $2}' | grep -q '.'; then
                echo "Found an adb entry"
                break
              fi
              sleep 3
            done

            # restart adb server to avoid stale/unauthorized/offline state
            adb kill-server || true
            adb start-server || true
            sleep 2

            # Robust wait: require 'device' state and sys.boot_completed + bootanim stopped
            READY=0
            for i in $(seq 1 120); do
              echo "Attempt $i: list devices"
              adb devices -l

              SERIAL=$(adb devices | awk 'NR>1 && $2=="device" {print $1; exit}')
              if [ -n "$SERIAL" ]; then
                echo "Device in 'device' state: $SERIAL"
                BOOT_COMPLETED=$(adb -s "$SERIAL" shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
                BOOTANIM=$(adb -s "$SERIAL" shell getprop init.svc.bootanim 2>/dev/null | tr -d '\r' || echo "")
                echo "sys.boot_completed=${BOOT_COMPLETED}, init.svc.bootanim=${BOOTANIM}"
                if [ "$BOOT_COMPLETED" = "1" ] && { [ -z "$BOOTANIM" ] || [ "$BOOTANIM" = "stopped" ]; }; then
                  READY=1
                  break
                fi
              else
                if adb devices | grep -q offline; then
                  echo "Found offline device(s) — restarting adb"
                  adb kill-server || true
                  adb start-server || true
                fi
              fi
              sleep 5
            done

            if [ "$READY" -ne 1 ]; then
              echo "ERROR: emulator never reached ready state. Dumping debug info..."
              adb devices -l || true
              adb -s emulator-5554 logcat -d | tail -n 200 || true
              exit 1
            fi

            echo "Device ready — installing APK"
            mkdir -p artifacts
            if [ ! -f artifacts/gesturelab.apk ]; then
              echo "ERROR: APK not found at artifacts/gesturelab.apk"
              ls -la artifacts || true
              exit 1
            fi

            SERIAL=$(adb devices | awk 'NR>1 && $2=="device" {print $1; exit}')
            echo "Installing to serial: $SERIAL"
            adb -s "$SERIAL" install -r artifacts/gesturelab.apk

            echo "APK installed; listing installed packages (first 50)"
            adb -s "$SERIAL" shell pm list packages | head -n 50 || true

            echo "Emulator + APK ready."

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          set -eux
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node and Appium (v2) and start Appium server
        run: |
          set -eux
          curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs build-essential
          # try to install a pinned Appium version, fallback to latest if not available
          sudo npm install -g appium@2.1.2 || sudo npm install -g appium
          APP_LOG=appium.log
          # start Appium in background with base-path /wd/hub (many clients expect /wd/hub)
          nohup appium --base-path /wd/hub &> "$APP_LOG" &
          # wait for Appium to be ready
          for i in $(seq 1 40); do
            echo "Checking Appium ($i/40)..."
            if curl -sS http://127.0.0.1:4723/wd/hub/status 2>/dev/null | grep -q '"ready":true'; then
              echo "Appium ready"
              break
            fi
            sleep 2
          done
          if ! curl -sS http://127.0.0.1:4723/wd/hub/status 2>/dev/null | grep -q '"ready":true'; then
            echo "Appium failed to start; printing last 200 lines of $APP_LOG"
            tail -n 200 "$APP_LOG" || true
            cat "$APP_LOG" || true
            exit 1
          fi
          ps aux | grep -E "appium|node" || true

      - name: Run pytest (Appium tests) and generate HTML report
        run: |
          set -eux
          pytest gesture_lab_apk/ --html=report.html --self-contained-html -q

      - name: Upload pytest HTML report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: report.html

      - name: Collect logs (adb logcat and appium log)
        run: |
          set -eux
          adb devices -l || true
          adb -s emulator-5554 logcat -d > adb_logcat.txt || true
          tar -czf logs.tar.gz appium.log adb_logcat.txt || true

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: logs.tar.gz
