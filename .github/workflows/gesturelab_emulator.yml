name: gesturelab-emulator-ci

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  run-emulator-and-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    env:
      # Optional: if you set this secret it will be available; conftest.py already
      # falls back to http://127.0.0.1:4723/wd/hub when empty/missing.
      APPIUM_SERVER_URL: ${{ secrets.APPIUM_SERVER_URL }}
      DEVICE_NAME: emulator-5554

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Java (required for Android SDK/tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Launch Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          target: google_apis
          arch: x86_64
          profile: pixel_6
          script: |
            echo "✅ Emulator launched successfully"
            adb devices -l
            # wait for boot (safety): sys.boot_completed=1
            for i in $(seq 1 60); do
              BOOT=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
              echo "boot=$BOOT (try $i)"
              if [ "$BOOT" = "1" ]; then
                echo "Emulator fully booted"
                break
              fi
              sleep 5
            done
            adb devices -l
    
      - name: Install APK onto emulator (robust wait + install)
        run: |
          set -eux
          mkdir -p artifacts
          if [ ! -f artifacts/gesturelab.apk ]; then
            echo "ERROR: APK not found at artifacts/gesturelab.apk"
            ls -la artifacts || true
            exit 1
          fi

          echo "Ensure adb server running..."
          adb kill-server || true
          adb start-server

          # Wait until we have a 'device' (not offline) OR give up after N tries.
          READY=0
          for i in $(seq 1 60); do
            echo "Checking adb devices (attempt $i)..."
            adb devices -l
          
          # If any device is in 'device' state, assume it's ready enough to check boot property
          if adb devices | awk 'NR>1 && $2=="device" {print $1; exit 0}'; then
            SERIAL=$(adb devices | awk 'NR>1 && $2=="device" {print $1; exit}')
            echo "Found device: $SERIAL — checking sys.boot_completed..."
            BOOT=$(adb -s "$SERIAL" shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
            echo "sys.boot_completed=$BOOT"
            if [ "$BOOT" = "1" ]; then
              READY=1
              break
            fi
          fi  
        
          # If we see offline device(s), try restarting adb once to recover
          if adb devices | grep -q offline; then
            echo "Found 'offline' devices — restarting adb server and retrying..."
            adb kill-server || true
            adb start-server
          fi
          sleep 5
          done

          if [ "$READY" -ne 1 ]; then
            echo "ERROR: emulator never reached device/booted state. Dumping debug info..."
            adb devices -l || true
            adb logcat -d | tail -n 200 || true
            exit 1
          fi

          echo "Device ready. Installing APK..."
          SERIAL=$(adb devices | awk 'NR>1 && $2=="device" {print $1; exit}')
          adb -s "$SERIAL" install -r artifacts/gesturelab.apk

      - name: Set up Python 3.11 and install Python dependencies
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Python dependencies
        run: |
          set -eux
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node and Appium (v2) and start Appium server
        run: |
          set -eux
          curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs build-essential
          # try to install pinned appium or fallback to latest
          sudo npm install -g appium@2.1.2 || sudo npm install -g appium
          APP_LOG=appium.log
          # start Appium with base-path /wd/hub so clients expecting /wd/hub work
          nohup appium --base-path /wd/hub &> "$APP_LOG" &
          # wait for Appium to report ready
          for i in $(seq 1 40); do
            echo "Checking Appium ($i/40)..."
            if curl -sS http://127.0.0.1:4723/wd/hub/status 2>/dev/null | grep -q '"ready":true'; then
              echo "Appium is ready"
              break
            fi
            sleep 2
          done
          if ! curl -sS http://127.0.0.1:4723/wd/hub/status 2>/dev/null | grep -q '"ready":true'; then
            echo "Appium failed to start; dumping last 200 lines of $APP_LOG"
            tail -n 200 "$APP_LOG" || true
            cat "$APP_LOG" || true
            exit 1
          fi
          ps aux | grep -E "appium|node" || true

      - name: Run pytest (Appium tests) and generate HTML report
        run: |
          set -eux
          # run tests in the gesture_lab_apk folder (adjust path if needed)
          pytest gesture_lab_apk/ --maxfail=1 --html=report.html --self-contained-html -q

      - name: Upload pytest HTML report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: report.html

      - name: Upload Appium log and adb logcat
        run: |
          set -eux
          # collect adb log (optional) and appium log
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/platform-tools
          adb logcat -d > adb_logcat.txt || true
          tar -czf logs.tar.gz appium.log adb_logcat.txt || true
        # upload logs as artifact
      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: emulator-logs
          path: logs.tar.gz
