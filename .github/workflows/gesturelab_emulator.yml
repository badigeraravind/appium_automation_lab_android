name: gesturelab_tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      APPIUM_SERVER_URL: ${{ secrets.APPIUM_SERVER_URL }}
      CHROMEDRIVER_PATH: ${{ secrets.CHROMEDRIVER_PATH }}
      DEVICE_NAME: emulator-5554

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
       
      - name: Setup Java (required for Android tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Install Android SDK & system image
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip libgl1-mesa-dev qemu-kvm
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          sudo mkdir -p $ANDROID_SDK_ROOT
          cd /tmp
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
          sudo unzip cmdline-tools.zip -d $ANDROID_SDK_ROOT
          # move into "latest" folder expected by sdkmanager
          sudo mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
          sudo mv $ANDROID_SDK_ROOT/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/
          export PATH=$PATH:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
          yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools" "platforms;android-33" "system-images;android-33;google_apis;x86_64" "emulator"

      - name: Create & start Android emulator (headless)
        run: |
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/emulator:$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin
          echo "no" | avdmanager create avd -n testAVD -k "system-images;android-33;google_apis;x86_64" --force
          # start emulator in background (headless)
          $ANDROID_SDK_ROOT/emulator/emulator -avd testAVD -no-window -no-audio -gpu swiftshader_indirect -accel on &

      - name: Wait for emulator to boot
        run: |
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/platform-tools
          adb wait-for-device
          for i in {1..60}; do
            BOOT=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r' || echo "")
            echo "Emulator boot status: '$BOOT' (attempt $i)"
            if [ "$BOOT" = "1" ]; then
              echo "emulator booted"
              break
            fi
            sleep 5
          done
          adb devices

      - name: Install APK onto emulator
        run: |
          export ANDROID_SDK_ROOT=/usr/local/android-sdk
          export PATH=$PATH:$ANDROID_SDK_ROOT/platform-tools
          if [ -f artifacts/gesturelab.apk ]; then
            adb install -r artifacts/gesturelab.apk
          else
            echo "APK not found at artifacts/gesturelab.apk â€” update workflow or add APK to repo"
            exit 1
          fi

      - name: Set up Python & install dependencies
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Node and Appium, start Appium server
        run: |
          set -e
          curl -sL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs build-essential
          sudo npm install -g appium@2.1.2 || sudo npm install -g appium
          APP_LOG=appium.log
          nohup appium --base-path /wd/hub &> "$APP_LOG" &
          # wait for Appium to be ready
          for i in $(seq 1 30); do
            echo "Checking Appium ($i/30)..."
            if curl -sS http://127.0.0.1:4723/wd/hub/status 2>/dev/null | grep -q '"ready":true'; then
              echo "Appium ready"
              break
            fi
            sleep 2
          done
          if ! curl -sS http://127.0.0.1:4723/wd/hub/status 2>/dev/null | grep -q '"ready":true'; then
            echo "Appium failed to start; last 200 lines of $APP_LOG:"
            tail -n 200 "$APP_LOG" || true
            exit 1
          fi
          ps aux | grep -E "node|appium" || true

      - name: Run pytest and generate HTML report
        run: |
          pytest gesture_lab_apk/ --html=report.html --self-contained-html -q

      - name: Upload pytest HTML report
        uses: actions/upload-artifact@v4
        with:
          name: pytest-report
          path: report.html

      - name: Upload Appium log
        uses: actions/upload-artifact@v4
        with:
          name: appium-log
          path: appium.log
       